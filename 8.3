// ---- rbac.js ----
import express from "express";
import jwt from "jsonwebtoken";
import bodyParser from "body-parser";

const app = express();
const PORT = 3000;
const SECRET = "supersecretkey";

app.use(bodyParser.json());

// ------------------- Mock Users -------------------
const users = [
  { id: 1, username: "admin", password: "admin123", role: "admin" },
  { id: 2, username: "mod", password: "mod123", role: "moderator" },
  { id: 3, username: "user", password: "user123", role: "user" },
];

// ------------------- JWT Authentication -------------------
function generateToken(user) {
  return jwt.sign({ id: user.id, role: user.role }, SECRET, { expiresIn: "1h" });
}

function authenticateToken(req, res, next) {
  const header = req.headers["authorization"];
  const token = header && header.split(" ")[1];
  if (!token) return res.status(401).json({ message: "Missing token" });

  jwt.verify(token, SECRET, (err, user) => {
    if (err) return res.status(403).json({ message: "Invalid token" });
    req.user = user;
    next();
  });
}

// ------------------- Role Authorization Middleware -------------------
function authorizeRoles(...allowedRoles) {
  return (req, res, next) => {
    if (!req.user || !allowedRoles.includes(req.user.role)) {
      return res.status(403).json({ message: "Access denied: insufficient role" });
    }
    next();
  };
}

// ------------------- Routes -------------------

// Public route
app.get("/", (req, res) => {
  res.send(`
    <h1>ðŸŽ¯ Role-Based Access Control (RBAC)</h1>
    <p>Try these routes:</p>
    <ul>
      <li>POST /login (with JSON body {"username":"admin","password":"admin123"})</li>
      <li>GET /admin (Admin only)</li>
      <li>GET /moderator (Admin + Moderator)</li>
      <li>GET /user (All roles)</li>
    </ul>
  `);
});

// Login to get token
app.post("/login", (req, res) => {
  const { username, password } = req.body;
  const user = users.find((u) => u.username === username && u.password === password);
  if (!user) return res.status(401).json({ message: "Invalid credentials" });

  const token = generateToken(user);
  res.json({ message: "Login successful", token });
});

// User route (all roles)
app.get("/user", authenticateToken, authorizeRoles("user", "moderator", "admin"), (req, res) => {
  res.json({ message: `Hello ${req.user.role}, you have access to USER route` });
});

// Moderator route
app.get("/moderator", authenticateToken, authorizeRoles("moderator", "admin"), (req, res) => {
  res.json({ message: `Hello ${req.user.role}, you have access to MODERATOR route` });
});

// Admin route
app.get("/admin", authenticateToken, authorizeRoles("admin"), (req, res) => {
  res.json({ message: `Welcome Admin! Full access granted.` });
});

// ------------------- Start Server -------------------
app.listen(PORT, () => console.log(`ðŸš€ RBAC server running on http://localhost:${PORT}`));
